# 网关

## 定义

​        出现在系统边界上得一个面向API的、串行集中式的强管控服务，这里的边界值得是企业的IT系统的边界，可以理解为`企业级应用防火墙`，主要起到`隔离外部访问和内部系统的作用`。在微服务概念流行之前，API网关就已经诞生，例如银行、证券等领域的前置系统，它也是解决访问认证、报文转换、访问统计等问题的。

​		抽象定义：API网关是一个服务器，是系统对外的唯一入口，API网关封装了系统内部架构，为每个客户端提供定制的API。所有客户端和消费端都通过统一的网关接入微服务，在网关层处理所有非业务功能。API网关并不是微服务场景中必须的组件，如下图，不管有没有API网关，后端微服务都可以通过API很好地支持客户端的访问。

## 使用网关的原因

* 单体应用：浏览器发起请求到单体应用所在的机器，应用从数据库中查询数据原路返回，对于单体应用来说，不需要网关

* 微服务：微服务的应用可能部署在不同机房，不同区域，不同域名下，此时客户端（浏览器/手机App）想要请求对应的服务，都需要知道机器的具体的URL，对于客户端来说，非常难维护。若有了网关，客户端的所有请求直接发送到网关，由网关根据请求标识解析判断出具体微服务的地址，再把请求转发到微服务的实例。

优点
* 易于监控，可在微服务网关手机监控数据并将其推动到外部系统进行分析
* 易于认证，可在微服务网关上进行认证，然后将请求转发到后端的微服务上，从而无需在每个微服务中进行认证
* 减少了客户端与各个为微服务之间的交互次数

## 应具有的功能

* 身份认证与安全

* 审查与监控

* 动态路由（最核心之一）

* 负载均衡

* 缓存

* 请求分片与管理

* 静态响应

   

   从各个指标上进行总结

* 性能：API高可用、负载均衡、容错机制
* 安全：权限身份认证、拖敏、流量清洗、后端签名（保证全链路可信调用），黑名单（非法调用的限制）
* 日志：日志记录，一旦涉及到分布式，全链路跟踪必不可少
* 缓存：数据缓存
* 监控：记录请求响应数据、API耗时分析，性能监控
* 限流：流量控制，错峰流控，定义多种限流规则
* 灰度：线上灰度部署，可以减小风险
* 路由：动态路由规则

  ## 网关过滤器

### 关键名词

*  类型：定义路由流程中应用过滤器的阶段，共pre、routing、post、error4个类型
* 执行顺序：在同类型中，定义过滤器执行的顺序
* 条件：执行过滤器所需的条件。true开启，false关闭
* 动作：如果符合条件，将执行的动作。具体操作

### 过滤器类型

* pre：请求被路由到服务器之前执行的过滤器

  * 身份认证
  * 选路由
  * 请求日志
* routing：处理将请求发送到源服务器的过滤器
* post：响应从源服务器返回时执行的过滤器
  * 对响应头增加HTTP头部
  * 收集统计和度量指标
  * 将响应以流的方式发送回客户端
* error：上述阶段中出现错误时执行的过滤器
### zuul请求生命周期

![image-20210124163045778](C:\Users\abc\AppData\Roaming\Typora\typora-user-images\image-20210124163045778.png)